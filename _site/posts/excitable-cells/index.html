<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Johannes Enevoldsen">
<meta name="dcterms.date" content="2025-02-18">
<meta name="description" content="A demonstration of how reentry tachyarrhythmias can develop in a system of excitable cells.">

<title>Johannes Enevoldsen - Excitable cells</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon/apple-touch-icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- Cloudflare Web Analytics -->
<script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;68c72ac082624ce1ba03627ceffa8505&quot;}"></script>
<!-- End Cloudflare Web Analytics -->


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Johannes Enevoldsen</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JohannesNE/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/johsenevoldsen.bsky.social"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="ri:bluesky-fill" aria-label="Icon bluesky-fill from ri Iconify.design set." title="Icon bluesky-fill from ri Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0002-9190-6566/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa-brands:orcid" aria-label="Icon orcid from fa-brands Iconify.design set." title="Icon orcid from fa-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Excitable cells</h1>
                  <div>
        <div class="description">
          A demonstration of how reentry tachyarrhythmias can develop in a system of excitable cells.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Johannes Enevoldsen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 18, 2025</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">March 28, 2025</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>I wrote this post to answer some of the questions I had as a medical student, when I first learned about cardiac arrhythmias. Mainly, what are the conditions required to initiate and maintain a state, where the heart muscles are continuously activated independent of the normal pace-making system‚Äîa so called <em>reentrant arrhythmia</em>. These arrhythmias can be benign, as with <a href="https://en.wikipedia.org/wiki/AV_nodal_reentrant_tachycardia">AV-nodal reentry tachycardia (AVNRT)</a>; a common, and usually harmless, cause of palpitations in young people. Or they can be deadly, as with <a href="https://en.wikipedia.org/wiki/Ventricular_fibrillation">ventricular fibrillation</a>.</p>
<p>Heart muscle cells (cardiomyocytes) have some interesting properties. When they are activated, they <a href="https://en.wikipedia.org/wiki/Depolarization">depolarize</a>. Depolarization causes the cell to contract, but also activates neighboring cells, setting of a chain reaction.</p>
<p>For the following demonstrations, we use i highly simplified model of heart. Below is a grid of simulated cardiomyocytes, each ready to activate their neighboring cells. They all start in a <em>resting state</em>, ready to be <em>activated</em>.</p>
<p>Activated cells are black. After a short moment, they become inactive and <em>refractory</em>. Refractory cells cannot be activated. In the simulation, refractory cells go from dark gray to light gray, until they have regained their resting state, and are ready for a new activation.</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è Click/tap anywhere in the box below to activate a cell.</p>
</blockquote>
<div class="simcontainer">
<canvas id="sim_tiny" width="500" height="500">
</canvas>
</div>
<p>Notice, that the activation is not entirely symmetric and predictable. To give the simulation a more organic feel, I added a bit of randomness to the activation of cells. Each cell is activated with a higher probability the more of its four neighbors are active (33% chance if one neighbor is active, 100% chance when 3 or 4 neighbors are active).</p>
<section id="pacemaker-cells" class="level2">
<h2 class="anchored" data-anchor-id="pacemaker-cells">Pacemaker cells</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/sinus.jpg" class="img-fluid figure-img"></p>
<figcaption>Sinus rhythm. From <a href="https://ecgpedia.org">ECGpedia</a>.</figcaption>
</figure>
</div>
<p>Another interesting property of cardiomyocytes is their <em>automaticity</em>; cardiomyocytes spontaneously activate if they are not stimulated by a neighboring cells for a period. Cells in the <em>sinoatrial node</em> (sinus node) in the right atrium have the fastest rate of spontaneous activation, and thus activate the remaining heart, making the sinus node the heart‚Äôs pacemaker.</p>
<p>In the following simulation, a cluster of cells in the top left corner act as pacemaker cells.</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è Move the slider below the simulation to change the rate of spontaneous depolarization (heart rate).</p>
</blockquote>
<div class="simcontainer">
<canvas id="sim_pace" width="500" height="500">
</canvas>
<div class="slidercontainer">
<p><input type="range" min="40" max="100" value="60" class="slider" id="slider_sim_pace"></p>
</div>
</div>
<p>When the spontaneous depolarization of the sinus node determines the heart rate, the heart is said to be in <a href="https://en.wikipedia.org/wiki/Sinus_rhythm">sinus rhythm</a>, which is the normal (physiological) activation path of the heart. If the sinus node paces the heart at a rate faster than 100 beats per minute, the rhythm is called <a href="https://en.wikipedia.org/wiki/Sinus_tachycardia">sinus tachycardia</a>. Sinus tachycardia (together with increased stroke volume) increases the flow of blood from the heart, and is the physiological response to exercise.</p>
</section>
<section id="reentry-tachycardia" class="level2">
<h2 class="anchored" data-anchor-id="reentry-tachycardia">Reentry tachycardia</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/VT.jpeg" class="img-fluid figure-img"></p>
<figcaption>Ventricular tachycardia. From <a href="https://ecgpedia.org">Ecgpedia</a>.</figcaption>
</figure>
</div>
<p>In reentry tachycardia, the heart is not paced by the sinus node, but instead from a group of cells that have formed a circuit, where a wave of depolarization can loop around and stimulate itself over and over. This requires a non-responsive area among the cells (an area that cannot be activated), so a circuit can form around it.</p>
<p>In the simulation below, the red cells are non-responsive (dead). They could represent scar tissue after a <a href="https://en.wikipedia.org/wiki/Myocardial_infarction">myocardial infarction</a>‚Äî<a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2744510/">a common cause of ventricular tachycardia</a>. Or the simulation could illustrate <a href="https://en.wikipedia.org/wiki/Atrial_flutter">atrial flutter</a>, where a reentrant loop can form around the tricuspid valve.</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è To stop the reentrant tachycardia, shock the cardiac cells by pressing the ‚Äú‚ö°Ô∏è Defibrillate!‚Äù button.</p>
</blockquote>
<div class="simcontainer">
<canvas id="sim_reentry1" width="500" height="500">
</canvas>
<p><br> <button type="button" id="button_reentry1" class="btn btn-primary">‚ö°Ô∏è Defibrillate!</button></p>
</div>
<p>After defibrillation, the system is in sinus rhythm. The pacemaker cells were always there, but were suppressed by the reentrant loop.</p>
<p>The simulation above illustrates how a reentrant loop can sustain itself around a dead area, but how does it start in the first place?</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è You can try to click/tap on the simulation above to set of an ectopic beat (a depolarization starting outside the sinus node), but you will not be able to initiate a reentrant loop again.</p>
</blockquote>
<section id="how-does-a-reentrant-loop-start" class="level3">
<h3 class="anchored" data-anchor-id="how-does-a-reentrant-loop-start">How does a reentrant loop start?</h3>
<p>To initiate a reentrant loop, the wave of depolarization must be traveling only one way around the dead area. Otherwise the two waves traveling in opposite will just eliminate each other when they meet at the other side. However, if one pathway has cells with a <strong>longer refractory period</strong>, a wave of depolarization can arrive exactly when one pathway is ready to depolarize, while the other is still refractory.</p>
<p>In the simulation below, cells in the lower left corner have a longer refractory period.</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è Try initiating an ectopic beat (click/tap) next to the area with a longer refractory period, while the area is still refractory.</p>
</blockquote>
<div class="simcontainer">
<canvas id="sim_reentry2" width="500" height="500">
</canvas>
<p><br> <button type="button" id="button_reentry2" class="btn btn-primary">‚ö°Ô∏è Defibrillate!</button></p>
</div>
<blockquote class="blockquote">
<p>üëÜÔ∏è You can get the system back in sinus rhythm either by ‚ö°Ô∏è defibrillation, or by cleverly timing a new ectopic beat to block the reentrant loop.</p>
</blockquote>
</section>
</section>
<section id="fibrillation" class="level2">
<h2 class="anchored" data-anchor-id="fibrillation">Fibrillation</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/Ventricular_Fibrillation.svg" class="img-fluid figure-img"></p>
<figcaption>Ventricular fibrillation. From <a href="https://ecgpedia.org">Ecgpedia</a>.</figcaption>
</figure>
</div>
<p>Another common cardiac arrythmia is fibrillation‚Äîatrial fibrillation or ventricular fibrillation. Fibrillation is a reentrant arrhythmia, but the wave of depolarization does not propagate around a fixed anatomical area, but rather meanders irregularly through the myocardium.</p>
<p>In the simulation below, cells have different refractory times. An ectopic depolarization will activate some cells, while others are still refractory. This can create a quite complex pattern of depolarization, and may create a reentrant loop, without any dead area to loop around.</p>
<blockquote class="blockquote">
<p>üëÜÔ∏è Try setting of a few ectopic beats in the simulation below, and see if you can initiate one or more reentrant loops.<br>
Make the system more unstable by changing the <strong>scale</strong> (with high scale, nearby cells have similar refractory times) and <strong>range</strong> (overall range of refractory times in the system). <strong>High range</strong> and <strong>low scale</strong> makes the system unstable.</p>
</blockquote>
<div class="simcontainer">
<canvas id="sim_afib" width="500" height="500">
</canvas>
<div class="slidercontainer">
<p><em>Set variability in refractory time.</em></p>
<p><strong>Scale:</strong> <input type="range" min="15" max="80" value="30" class="slider" id="slider_afib_scale"> <strong>Range:</strong> <input type="range" min="0" max="100" value="30" class="slider" id="slider_afib_percent"> <button type="button" id="button_afib" class="btn btn-primary">‚ö°Ô∏è Defibrillate!</button></p>
</div>
</div>
<p>Stimulating the system while some cells are refractory, while others are not, corresponds to an ectopic beat occurring during the T-wave of an ECG‚Äîa high-risk situation for ventricular fibrillation. Also, a high range of refractory times, corresponds to a wide T-wave in the ECG.</p>
</section>
<section id="acknowledgment" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgment">Acknowledgment</h2>
<p>This article is inspired by <a href="https://ciechanow.ski/">Bartosz Ciechanowski‚Äôs</a> amazing interactive articles.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script type="application/javascript" src="perlin.js"></script> <script type="application/javascript" src="script.js"></script>




</body></html>